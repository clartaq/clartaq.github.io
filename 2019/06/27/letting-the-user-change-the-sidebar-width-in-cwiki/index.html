<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.72.0" />

  <title>Letting the User Change the Sidebar Width in CWiki &middot; Yo-Dave</title>

    

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://yo-dave.com/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://yo-dave.com/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://yo-dave.com/css/blackburn.css">

  
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.9.0/css/all.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/clojure.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/lisp.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/dos.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://yo-dave.com/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  

  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yo-dave.com/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yo-dave.com/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yo-dave.com/about/about"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yo-dave.com/contact/contact"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href=""></a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/clartaq" rel="me" target="_blank"><i class="fab fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://bitbucket.org/David_Clark" rel="me" target="_blank"><i class="fab fa-bitbucket"></i>Bitbucket</a>
    </li>
    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://stackoverflow.com/users/193509" rel="me" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>Stack Overflow</a>
    </li>
    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2011-2020, David D. Clark. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Letting the User Change the Sidebar Width in CWiki</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>27 Jun 2019 4:51:20 PM</time>
  </div>

  

  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://yo-dave.com/tags/clojure">Clojure</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://yo-dave.com/tags/clojurescript">ClojureScript</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://yo-dave.com/tags/css">CSS</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://yo-dave.com/tags/html">HTML</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://yo-dave.com/tags/sidebar">sidebar</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://yo-dave.com/tags/technical-note">technical note</a>
    
  </div>
  
  

</div>

  <p>Recently, I&rsquo;ve been working on what I thought was a simple feature &ndash; changing the width of the sidebar in the <a href="https://helixteamhub.cloud/Regolith/projects/binom-stats/repositories/cwiki/tree/default">CWiki</a> wiki program.</p>
<p>There were two ways the user could do it.</p>
<p>First, they could set it manually in the &ldquo;Preferences&rdquo; page.</p>
<p>Second, and more naturally in my opinion, they could use the mouse to drag the separator between the sidebar and the main article area to the location they wanted it.</p>
<p>Implementing the first method was trivial, if tedious. Just extending the existing machinery for the Preferences page was all it took.</p>
<p>The second method, using the mouse, was surprisingly difficult.</p>
<p>The first thing I wanted to do was give the user an indication that there was some action they could take. There was already a vertical rule between the sidebar and article area. However, it was too thin to easily click with the mouse and there was no indication that something could be done even if you managed to click it.</p>
<p>A little CSS magic was all that was needed. Another <code>div</code> was added next to the existing border. The new <code>div</code> was normally transparent, but when the mouse passes over, it becomes visible, appearing as a thicker version of the vertical rule. It also shows a different cursor shape, a standard HTML 5 <code>col-resize</code> cursor.</p>
<p>The combination of the change in cursor shape and the apparent thickening of the border indicates that there is something different that you can do there. Clicking and dragging the mouse changes the width of the sidebar dynamically. On some browsers, the color of the divider changes as well.</p>
<p>The code that handles the (slightly) revised page layout is simple.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Clojure" data-lang="Clojure">(<span style="color:#66d9ef">defn </span>sidebar-and-article
  <span style="color:#e6db74">&#34;Return a sidebar and article div with the given content.&#34;</span>
  [sidebar article]
  [<span style="color:#e6db74">:div</span> {<span style="color:#e6db74">:class</span> <span style="color:#e6db74">&#34;sidebar-and-article&#34;</span>}
   sidebar
   [<span style="color:#e6db74">:div</span> {<span style="color:#e6db74">:class</span> <span style="color:#e6db74">&#34;vertical-page-divider&#34;</span>}]
   [<span style="color:#e6db74">:div</span> {<span style="color:#e6db74">:class</span>       <span style="color:#e6db74">&#34;vertical-page-splitter&#34;</span>
          <span style="color:#e6db74">:id</span>          <span style="color:#e6db74">&#34;splitter&#34;</span>
          <span style="color:#75715e">; Don&#39;t forget to translate the hyphen to an underscore. The false</span>
          <span style="color:#75715e">; return is required for correct behavior on Safari.</span>
          <span style="color:#e6db74">:onmousedown</span> <span style="color:#e6db74">&#34;cwiki_mde.dragger.onclick_handler(); return false;&#34;</span>}]
   [<span style="color:#e6db74">:article</span> {<span style="color:#e6db74">:class</span> <span style="color:#e6db74">&#34;page-content&#34;</span>}
    article]])
</code></pre></div><p>The CSS that handles the hover and active states is pretty clever. I seem to have lost the link to the StackOverflow question where I found this.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-CSS" data-lang="CSS"><span style="color:#75715e">/* Set up some indicators for dragging the boundary. */</span>

.<span style="color:#a6e22e">vertical-page-divider</span> {
    <span style="color:#66d9ef">border-left</span>: <span style="color:#ae81ff">1</span><span style="color:#66d9ef">px</span> <span style="color:#66d9ef">solid</span> <span style="color:#a6e22e">var</span>(<span style="color:#f92672">--</span>rule<span style="color:#f92672">-</span><span style="color:#66d9ef">color</span>);
}

.<span style="color:#a6e22e">vertical-page-splitter</span> {
    <span style="color:#66d9ef">display</span>: <span style="color:#66d9ef">flex</span>;
    <span style="color:#66d9ef">flex-direction</span>: <span style="color:#66d9ef">column</span>;

    <span style="color:#66d9ef">width</span>: <span style="color:#ae81ff">10</span><span style="color:#66d9ef">px</span>;
    <span style="color:#66d9ef">max-width</span>: <span style="color:#ae81ff">10</span><span style="color:#66d9ef">px</span>;
    <span style="color:#66d9ef">background-color</span>: <span style="color:#a6e22e">var</span>(<span style="color:#f92672">--</span>rule<span style="color:#f92672">-</span><span style="color:#66d9ef">color</span>);
    <span style="color:#66d9ef">opacity</span>: <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">transition</span>: <span style="color:#ae81ff">0.3</span><span style="color:#66d9ef">s</span>;
}

.<span style="color:#a6e22e">vertical-page-splitter</span>:<span style="color:#a6e22e">hover</span> {
    <span style="color:#66d9ef">cursor</span>: <span style="color:#66d9ef">col-resize</span>;
    <span style="color:#66d9ef">opacity</span>: <span style="color:#ae81ff">1</span>;
}

.<span style="color:#a6e22e">vertical-page-splitter</span>:<span style="color:#a6e22e">active</span> {
    <span style="color:#66d9ef">cursor</span>: <span style="color:#66d9ef">col-resize</span>;
    <span style="color:#66d9ef">background-color</span>: <span style="color:#66d9ef">pink</span>;
}
</code></pre></div><p>The code to change the width was the hard part. The first part of that puzzle was the event handler shown in the layout code above. For the longest time, I had the click handler as:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure"><span style="color:#e6db74">&#34;cwiki_mde.dragger.onclick_handler();&#34;</span>
</code></pre></div><p>And that mostly worked. Note the use of the underscore character &ldquo;_&rdquo; rather than the more idiomatic hyphen. It has to be an underscore.</p>
<p>However, it didn&rsquo;t work perfectly with Safari. In Safari, the cursor changed shape correctly, but once the mouse moved, the cursor changed back to an &ldquo;I-beam&rdquo; text cursor. That was fixed by changing the call to:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure"><span style="color:#e6db74">&#34;cwiki_mde.dragger.onclick_handler(); return false;&#34;</span>
</code></pre></div><p>Note the addition of <code>return false;</code> at the end. You need that to make Safari work.</p>
<p>The code referred to in the event handler is in a new namespace: <code>cwiki-mde.dragger</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure"><span style="color:#75715e">;;;;</span>
<span style="color:#75715e">;;;; A utility function to handle dragging the border between the sidebar</span>
<span style="color:#75715e">;;;; and article portion of the page. To allow changing the width of the</span>
<span style="color:#75715e">;;;; sidebar with a mouse drag.</span>

(<span style="color:#66d9ef">ns </span>cwiki-mde.dragger
  (<span style="color:#e6db74">:require</span> [ajax.core <span style="color:#e6db74">:refer</span> [ajax-request text-request-format
                               text-response-format]]))

<span style="color:#75715e">;; The minimum allowable width for the sidebar.</span>
(<span style="color:#66d9ef">def </span><span style="color:#f92672">^</span>{<span style="color:#e6db74">:private</span> true <span style="color:#e6db74">:const</span> true} min-sidebar-basis <span style="color:#ae81ff">150</span>)

<span style="color:#75715e">;; Could calculate this, but this is easier. This value must match that</span>
<span style="color:#75715e">;; used in the css file for the sidebar.</span>

(<span style="color:#66d9ef">def </span><span style="color:#f92672">^</span>{<span style="color:#e6db74">:private</span> true <span style="color:#e6db74">:const</span> true} twice-padding-width <span style="color:#ae81ff">48</span>)

<span style="color:#75715e">;; The resolved elements, just so we don&#39;t have to keep recalculating them.</span>

(<span style="color:#66d9ef">def </span><span style="color:#f92672">^</span>{<span style="color:#e6db74">:private</span> true} sidebar-ele (<span style="color:#a6e22e">atom</span> nil))

<span style="color:#75715e">;; Other state.</span>

(<span style="color:#66d9ef">def </span><span style="color:#f92672">^</span>{<span style="color:#e6db74">:private</span> true} dragging (<span style="color:#a6e22e">atom</span> false))
(<span style="color:#66d9ef">def </span><span style="color:#f92672">^</span>{<span style="color:#e6db74">:private</span> true} starting-mouse-x (<span style="color:#a6e22e">atom</span> <span style="color:#ae81ff">0</span>))
(<span style="color:#66d9ef">def </span><span style="color:#f92672">^</span>{<span style="color:#e6db74">:private</span> true} starting-basis (<span style="color:#a6e22e">atom</span> <span style="color:#ae81ff">0</span>))
(<span style="color:#66d9ef">def </span><span style="color:#f92672">^</span>{<span style="color:#e6db74">:private</span> true} new-basis (<span style="color:#a6e22e">atom</span> <span style="color:#e6db74">&#34;0px&#34;</span>))

(<span style="color:#66d9ef">defn </span>response-handler [[ok response]]
  (when-not ok
    (<span style="color:#a6e22e">.error</span> js/console (str <span style="color:#e6db74">&#34;Something bad happened: status: &#34;</span>
                            (<span style="color:#e6db74">:status</span> response)
                            <span style="color:#e6db74">&#34;, status-text: &#34;</span> (<span style="color:#e6db74">:status-text</span> response)))))

(<span style="color:#66d9ef">defn </span>persist-new-basis
  [new-basis]
  (<span style="color:#a6e22e">ajax-request</span>
    {<span style="color:#e6db74">:uri</span>             <span style="color:#e6db74">&#34;/width-of-sidebar&#34;</span>
     <span style="color:#e6db74">:method</span>          <span style="color:#e6db74">:post</span>
     <span style="color:#e6db74">:body</span>            new-basis
     <span style="color:#e6db74">:handler</span>         response-handler
     <span style="color:#e6db74">:format</span>          (<span style="color:#a6e22e">text-request-format</span>)
     <span style="color:#e6db74">:response-format</span> (<span style="color:#a6e22e">text-response-format</span>)}))

(<span style="color:#66d9ef">defn- </span>move [evt]
  (when <span style="color:#f92672">@</span>dragging
    (<span style="color:#66d9ef">let </span>[movement (- (<span style="color:#a6e22e">.-pageX</span> evt) <span style="color:#f92672">@</span>starting-mouse-x)]
      (<span style="color:#a6e22e">reset!</span> new-basis (str (max min-sidebar-basis
                                  (+ <span style="color:#f92672">@</span>starting-basis movement)) <span style="color:#e6db74">&#34;px&#34;</span>))
      (<span style="color:#a6e22e">set!</span> (-&gt; (<span style="color:#a6e22e">.-style</span> <span style="color:#f92672">@</span>sidebar-ele) .-flexBasis) <span style="color:#f92672">@</span>new-basis))))

(<span style="color:#66d9ef">defn- </span>stop-tracking [_]
  (when <span style="color:#f92672">@</span>dragging
    (<span style="color:#a6e22e">reset!</span> dragging false)
    (<span style="color:#a6e22e">.removeEventListener</span> js/window <span style="color:#e6db74">&#34;mousemove&#34;</span> move)
    (when (not= <span style="color:#f92672">@</span>starting-basis <span style="color:#f92672">@</span>new-basis)
      (<span style="color:#a6e22e">persist-new-basis</span> <span style="color:#f92672">@</span>new-basis))))

(<span style="color:#66d9ef">defn- </span>start-tracking [evt]
  (<span style="color:#a6e22e">reset!</span> starting-mouse-x (<span style="color:#a6e22e">.-pageX</span> evt)))

(<span style="color:#66d9ef">defn </span><span style="color:#f92672">^</span>{<span style="color:#e6db74">:export</span> true} onclick_handler []
  (<span style="color:#a6e22e">reset!</span> sidebar-ele (<span style="color:#a6e22e">.getElementById</span> js/document <span style="color:#e6db74">&#34;left-aside&#34;</span>))
  (<span style="color:#a6e22e">reset!</span> starting-basis (- (<span style="color:#a6e22e">.-offsetWidth</span> <span style="color:#f92672">@</span>sidebar-ele) twice-padding-width))
  (<span style="color:#a6e22e">reset!</span> dragging true)
  (<span style="color:#a6e22e">.addEventListener</span> js/window <span style="color:#e6db74">&#34;mousedown&#34;</span> start-tracking)
  (<span style="color:#a6e22e">.addEventListener</span> js/window <span style="color:#e6db74">&#34;mousemove&#34;</span> move)
  (<span style="color:#a6e22e">.addEventListener</span> js/window <span style="color:#e6db74">&#34;mouseup&#34;</span> stop-tracking))
</code></pre></div><p>I couldn&rsquo;t figure out a way to pass arguments or get data back from a handler that was called from Clojure/Hiccup. In fact, I was surprised that calling ClojureScript from Clojure worked at all. That&rsquo;s why there is an apparently pointless <code>start-tracking</code> function &ndash; I could have done the same thing in the <code>onclick_handler</code>, but I needed the event.</p>
<p>For the longest time, I couldn&rsquo;t figure out what might be a good way to pass the new width from the ClojureScript client code back to the server running Clojure. There is <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API">WebSocket</a> machinery elsewhere in the client to handle communication back and forth between the editor and the server. But that seemed like it could be unreliable and buggy. Eventually, I looked into <a href="https://en.wikipedia.org/wiki/Ajax_%28programming%29">AJAX</a>, something I had never tried before. The <a href="https://github.com/JulianBirch/cljs-ajax"><code>cljs-ajax</code></a> library made it pretty easy though.</p>
<p>So, this code takes care of moving the divider and updating the layout as the mouse is moved. When the user completes the drag operation, if the new position of the divider differs from the original, an AJAX call is made back into the server code in Clojure to persist the data.</p>
<p>Here&rsquo;s the function in the <code>cwiki.routes.home</code> namespace that saves the new width to the options table in the database.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">(<span style="color:#66d9ef">defn </span>post-sidebar-basis
  <span style="color:#e6db74">&#34;Persist the sidebar width basis.&#34;</span>
  [req]
  (<span style="color:#66d9ef">let </span>[body <span style="color:#f92672">^</span>BytesInputStream (<span style="color:#e6db74">:body</span> req)
        new-basis (<span style="color:#a6e22e">safe-parse-int</span> (slurp (<span style="color:#a6e22e">.bytes</span> body)))]
    (<span style="color:#a6e22e">db/set-option-value</span> <span style="color:#e6db74">:sidebar_width</span> new-basis)
    {<span style="color:#e6db74">:status</span>  <span style="color:#ae81ff">200</span>}))
</code></pre></div><p>All of the page layout functions that put together a view with a sidebar were changed to use the value from the database rather than rely on the value in the CSS file.</p>
<p>Just for completeness, here&rsquo;s the <code>safe-parse-int</code> function used above.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">(<span style="color:#66d9ef">defn- </span>safe-parse-int
  <span style="color:#e6db74">&#34;Convert a string to an integer. Return -1 on exception. Parses the first
</span><span style="color:#e6db74">  (and only the first) contiguous group of digits.&#34;</span>
  [x]
  (<span style="color:#a6e22e">try</span> (<span style="color:#a6e22e">Integer/parseInt</span> (re-find  <span style="color:#f92672">#</span><span style="color:#e6db74">&#34;\d+&#34;</span> x))
       (<span style="color:#a6e22e">catch</span> Exception _
         <span style="color:#ae81ff">-1</span>)))
</code></pre></div><p>It&rsquo;s just a handy little utility function that I use here and there.</p>
<p>Now the user can change the width of the sidebar to whatever is useful/attractive to them.</p>

  
  

  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://yo-dave.com/2019/06/03/detecting-from-a-web-client-whether-a-particular-font-is-installed/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://yo-dave.com/2019/06/03/detecting-from-a-web-client-whether-a-particular-font-is-installed/">Detecting from a Web Client Whether a Particular Font is Installed</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://yo-dave.com/2019/08/25/setting-up-remote-repositories-for-mercurial/">Setting Up Remote Repositories for Mercurial</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://yo-dave.com/2019/08/25/setting-up-remote-repositories-for-mercurial/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>

</div>
</div>
<script src="https://yo-dave.com/js/ui.js"></script>
<script src="https://yo-dave.com/js/menus.js"></script>






<script src="https://yo-dave.com/js/math-code.js"></script>
  <script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  


</body>
</html>

